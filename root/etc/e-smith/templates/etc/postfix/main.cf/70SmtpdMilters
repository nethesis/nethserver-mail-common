#
# SMTPD_MILTER : all smtpd milter must be written on one line
# we look in default configuration to check if the milter is installed
#
# default action: accept (skip milters if something goes wrong)
# else set to 'reject'

milter_default_action = {$postfix{milterAction} || 'accept'}

# we look after 'SmtpdMilter' property in a key with a service type
# add your milter configuration inside like this
# for a unix socket
#'unix:/var/lib/rspamd/milter.sock'
# or for TCP socket
# 'smtpd_milters = inet:localhost:11332'

{
use esmith::ConfigDB;

my $confDb = esmith::ConfigDB->open_ro();
my @services = map { $_->key } $confDb->get_all_by_prop('type' => 'service');
my @milters;

foreach (@services) {
    next if ( ! -e "/etc/e-smith/db/configuration/defaults/$_/SmtpdMilter" );

    my $status = $confDb->get_prop("$_",'status') || 'disabled';
    next if ($status eq 'disabled');

    my $milter = $confDb->get_prop("$_",'SmtpdMilter');
    chomp $milter;

    push @milters, $milter;
}

$OUT .= 'smtpd_milters = ' . join (",\n ", @milters) ."\n";
}
